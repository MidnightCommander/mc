#! /bin/sh
# Midnight Commander - Brotli support
#
# Written by:
#  Vadim Kalinnikov <moose@ylsoftware.com>,
#
# This file is part of the Midnight Commander.
#
# It required brotli: https://github.com/google/brotli
# On Debian/Ubuntu brotli can be installed via:
# apt install brotli

command -v brotli >/dev/null 2>&1 || exit 1
BROTLI=$(command -v brotli 2>/dev/null)
AWK=@AWK@

[ -n "$2" ] || exit 1

ACTION=$1
BRFILENAME=$2


br_list() {
    BROUTFILENAME=$(basename "${BRFILENAME}" | sed -e 's/\.br$//')
    ls -l --time-style="+%d/%m/%Y %H:%M:%S" "${BRFILENAME}" | \
        ${AWK} -v f_name="${BROUTFILENAME}" '{
            attr=$1;
            uid=$2;
            gid=$4;
            f_size=$5;
            t_date=$6;
            t_time=$7;
            printf("%s 1 %s %s %s %s %s %s\n", attr, uid, gid, f_size, t_date, t_time, f_name);
        }'
}

br_copyout() {
    ${BROTLI} -dck "${BRFILENAME}" > "${FILENAMEDST}"
}

case "$ACTION" in
	list)
		br_list
	;;
	
	copyout)
		[ -n "$4" ] || exit 1
		FILENAMEDST="$4"
		br_copyout
	;;
	
	*)
		exit 1
	;;
esac

